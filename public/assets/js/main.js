"use strict";var app=angular.module("ngDrawing",["ngRoute","ngDrawing.services","ngDrawing.directives","ngDrawing.controllers"]);app.config(["$routeProvider",function(a){a.when("/intro",{activePage:"intro",templateUrl:"assets/partials/intro.html",controller:"introController"}),a.when("/playground",{activePage:"playground",templateUrl:"assets/partials/playground.html",controller:"playgroundController"}),a.otherwise({redirectTo:"/intro"})}]),app.run(["$rootScope","$route",function(a,b){a.$on("$routeChangeSuccess",function(){a.view=b.current.activePage})}]);var services=angular.module("ngDrawing.services",[]);angular.module("ngDrawing.controllers",[]).controller("introController",["$scope",function(){}]).controller("playgroundController",["$scope",function(){}]);var directives=angular.module("ngDrawing.directives",[]);directives.directive("notification",["$timeout",function(a){return{restrict:"E",templateUrl:"assets/partials/notification.html",link:function(b){b.$on("SEND_NOTIFICATION",function(c,d){b.active=!0,b.notification=d,a(function(){b.active=!1},3e3)})}}}]),directives.directive("typeahead",["canvasDrawFactory","commandService",function(a,b){return{restrict:"E",scope:{prompt:"@",title:"@",hint:"@",items:"=",model:"=",onSelect:"&"},templateUrl:"assets/partials/typeahead.html",link:function(a){var c=function(){a.current=0,a.selected=!0};a.handleSelection=function(b,d){c(),a.model=b,a.details=d,a.onSelect()},a.isCurrent=function(b){return a.current===b},a.setCurrent=function(b){a.current=b},a.reset=function(){a.model=null,a.details=null},a.submit=function(){var c=b.check(a.model);return"string"==typeof c?(console.warn(c),void a.$emit("SEND_NOTIFICATION",c)):void("clear"===b.command?a.$emit("SEND_CLEAR",a.model):a.$emit("SEND_COMMAND",a.model))},c()}}}]),directives.directive("drawingPanel",["canvasDrawFactory","commandService",function(a,b){return{restrict:"A",link:function(c,d){var e=d[0].getContext("2d");c.$on("SEND_COMMAND",function(){var c=b.params;"rectangle"===b.command&&a.rectangle(e,c[0],c[1],c[2],c[3],c[4]),"line"===b.command&&a.line(e,c[0],c[1],c[2],c[3],c[4]),"fill"===b.command&&a.bucket(e,c[0],c[1],c[2])})}}}]),directives.directive("painter",["drawCommands","canvasDrawFactory","commandService",function(a,b,c){return{restrict:"E",templateUrl:"assets/partials/painter.html",link:function(b){b.canvas={width:450,height:350,background:"white"},b.items=a.list,b.$on("SEND_CLEAR",function(){b.canvas.background=c.params[0]})}}}]),services.service("bucketService",function(){var a,b,c,d,e,f={},g=function(a){return parseInt(j(a).substring(0,2),16)},h=function(a){return parseInt(j(a).substring(2,4),16)},i=function(a){return parseInt(j(a).substring(4,6),16)},j=function(a){return"#"===a.charAt(0)?a.substring(1,7):a},k=function(){a.clearRect(0,0,a.canvas.width,a.canvas.height)},l=function(){k(),a.putImageData(d,0,0)},m=function(a,b,c,d){return 100>a+b+c&&255===d},n=function(a,b,c,g){var h=e.data[a],i=e.data[a+1],j=e.data[a+2],k=e.data[a+3];return m(h,i,j,k)?!1:(h=d.data[a],i=d.data[a+1],j=d.data[a+2],h===b&&i===c&&j===g?!0:h===f.r&&i===f.g&&j===f.b?!1:!0)},o=function(a,b,c,e,f){d.data[a]=b,d.data[a+1]=c,d.data[a+2]=e,d.data[a+3]=void 0!==f?f:255},p=function(a,d,e,g,h){for(var i,j,k,l,m,p,q=0,r=0,s=angular.copy(b-1),t=angular.copy(c-1),u=[[a,d]];u.length;){for(i=u.pop(),j=i[0],k=i[1],l=4*(k*b+j);k>=r&&n(l,e,g,h);)k-=1,l-=4*b;for(l+=4*b,k+=1,m=!1,p=!1;t>=k&&n(l,e,g,h);)k+=1,o(l,f.r,f.g,f.b),j>q&&(n(l-4,e,g,h)?m||(u.push([j-1,k]),m=!0):m&&(m=!1)),s>j&&(n(l+4,e,g,h)?p||(u.push([j+1,k]),p=!0):p&&(p=!1)),l+=4*b}},q=function(a,c){var e=4*(c*b+a),g=d.data[e],h=d.data[e+1],i=d.data[e+2],j=d.data[e+3];(g!==f.r||h!==f.g||i!==f.b)&&(m(g,h,i,j)||(p(a,c,g,h,i),l()))},r={init:function(f){a=f,b=a.canvas.width,c=a.canvas.height;try{e=a.getImageData(0,0,b,c)}catch(g){return void console.error("Application cannot be run locally. Please run on a server.")}d=a.getImageData(0,0,b,c)},paint:function(a,b,c){4===c.length&&(c="#"+c[1]+c[1]+c[2]+c[2]+c[3]+c[3]),f.r=g(c),f.g=h(c),f.b=i(c),q(a,b)}};return r}),services.factory("canvasDrawFactory",["bucketService",function(a){var b=function(){this.shapes=[]};return b.prototype.rectangle=function(a,b,c,d,e,f){a.beginPath(),a.rect(b,c,d,e),a.lineWidth=2,a.strokeStyle=f,a.stroke(),this.shapes.push("rectangle")},b.prototype.line=function(a,b,c,d,e,f){a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke(),a.lineWidth=2,a.strokeStyle=f,a.stroke(),this.shapes.push("line")},b.prototype.bucket=function(b,c,d,e){a.init(b),a.paint(c,d,e)},new b}]),services.service("commandService",["drawCommands",function(a){var b=a.list,c=function(a){for(var c=0,d=b.length;d>c;c++)if(b[c].name===a)return b[c];return!1},d=function(a,b){for(var c=/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i,d=0,e=a.format.length;e>d;d++){if("number"===a.format[d]&&(b[d]<0||b[d]>500))return!1;if("colour"===a.format[d]&&c.test(b[d])===!1)return!1}return!0},e={command:"",params:[],check:function(a){var b=a.split(" "),e=c(b[0]);return e?(this.command=b.shift(),this.params=b,d(e,b)?!0:"Warning: you didn't write the right parameters."):"Warning: you didn't write the right command."}};return e}]),app.constant("drawCommands",function(){return{list:[{name:"clear",description:"clear 'hex colour'",format:["colour"]},{name:"rectangle",description:"rectangle 'x' 'y' 'w' 'h' 'hex colour'",format:["number","number","number","number","colour"]},{name:"line",description:"line 'x1' 'y1' 'x2' 'y2' 'hex colour'",format:["number","number","number","number","colour"]},{name:"fill",description:"fill 'x' 'y' 'hex colour'",format:["number","number","colour"]}]}}());